#!/usr/bin/env bash
# ============================================================
# Module : outils_developpeur.sh
# Objectif : Outils sp√©cialis√©s pour d√©veloppeurs
# Usage : source outils_developpeur.sh
# Style : Fonctions courtes, pratiques pour le dev
# ============================================================

# Couleurs
VERT='\033[0;32m'
ROUGE='\033[0;31m'
JAUNE='\033[1;33m'
BLEU='\033[0;34m'
CYAN='\033[0;36m'
VIOLET='\033[0;35m'
NC='\033[0m'

afficher() {
    echo -e "${2:-$NC}$1${NC}"
}

# ========== ANALYSEUR DE CODE ==========

analyser_projet() {
    local dossier="${1:-.}"

    afficher "üìä ANALYSE DU PROJET: $dossier" $BLEU
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    if [[ ! -d "$dossier" ]]; then
        afficher "‚ùå Dossier '$dossier' introuvable" $ROUGE
        return 1
    fi

    # Statistiques de base
    local total_fichiers=$(find "$dossier" -type f 2>/dev/null | wc -l)
    local total_lignes=0

    # Analyse par type de fichier
    afficher "üìÅ Structure du projet:" $CYAN

    declare -A extensions
    declare -A lignes_par_ext

    # Parcourir les fichiers
    while IFS= read -r -d '' fichier; do
        local ext="${fichier##*.}"

        # Si pas d'extension
        if [[ "$ext" == "$fichier" ]]; then
            ext="sans_extension"
        fi

        # Compter
        extensions["$ext"]=$((${extensions["$ext"]:-0} + 1))

        # Compter lignes si c'est un fichier texte
        if file "$fichier" 2>/dev/null | grep -q "text"; then
            local lignes=$(wc -l < "$fichier" 2>/dev/null || echo 0)
            lignes_par_ext["$ext"]=$((${lignes_par_ext["$ext"]:-0} + lignes))
            total_lignes=$((total_lignes + lignes))
        fi

    done < <(find "$dossier" -type f -print0 2>/dev/null)

    # Afficher r√©sultats
    echo "   üìÑ Total fichiers: $total_fichiers"
    echo "   üìù Total lignes: $total_lignes"
    echo

    afficher "üè∑Ô∏è R√©partition par extension:" $CYAN
    for ext in "${!extensions[@]}"; do
        local count=${extensions["$ext"]}
        local lignes=${lignes_par_ext["$ext"]:-0}
        printf "   %-12s %3d fichiers" "$ext" "$count"
        if [[ $lignes -gt 0 ]]; then
            printf " (%d lignes)" "$lignes"
        fi
        echo
    done
}

detecter_langage_projet() {
    local dossier="${1:-.}"

    afficher "üîç D√©tection du langage principal..." $CYAN

    # Fichiers de configuration communs
    if [[ -f "$dossier/package.json" ]]; then
        afficher "üì¶ Projet Node.js/JavaScript d√©tect√©" $VERT
        if [[ -f "$dossier/tsconfig.json" ]]; then
            afficher "   TypeScript configur√©" $CYAN
        fi
    elif [[ -f "$dossier/requirements.txt" ]] || [[ -f "$dossier/setup.py" ]]; then
        afficher "üêç Projet Python d√©tect√©" $VERT
    elif [[ -f "$dossier/Cargo.toml" ]]; then
        afficher "ü¶Ä Projet Rust d√©tect√©" $VERT
    elif [[ -f "$dossier/go.mod" ]]; then
        afficher "üêπ Projet Go d√©tect√©" $VERT
    elif [[ -f "$dossier/composer.json" ]]; then
        afficher "üêò Projet PHP d√©tect√©" $VERT
    elif [[ -f "$dossier/pom.xml" ]] || [[ -f "$dossier/build.gradle" ]]; then
        afficher "‚òï Projet Java d√©tect√©" $VERT
    else
        # Analyser les extensions
        local js_files=$(find "$dossier" -name "*.js" 2>/dev/null | wc -l)
        local py_files=$(find "$dossier" -name "*.py" 2>/dev/null | wc -l)
        local sh_files=$(find "$dossier" -name "*.sh" 2>/dev/null | wc -l)

        if [[ $js_files -gt 0 ]]; then
            afficher "üìú Fichiers JavaScript trouv√©s ($js_files)" $JAUNE
        fi
        if [[ $py_files -gt 0 ]]; then
            afficher "üêç Fichiers Python trouv√©s ($py_files)" $JAUNE
        fi
        if [[ $sh_files -gt 0 ]]; then
            afficher "üêö Scripts shell trouv√©s ($sh_files)" $JAUNE
        fi
    fi
}

# ========== OUTILS GIT AVANC√âS ==========

git_statut_propre() {
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        afficher "‚ùå Pas dans un d√©p√¥t Git" $ROUGE
        return 1
    fi

    afficher "üìä STATUT GIT D√âTAILL√â" $BLEU
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    # Branche actuelle
    local branche=$(git branch --show-current)
    afficher "üåø Branche: $branche" $CYAN

    # Statut des fichiers
    local modifies=$(git status --porcelain | grep "^ M" | wc -l)
    local ajoutes=$(git status --porcelain | grep "^A" | wc -l)
    local supprimes=$(git status --porcelain | grep "^ D" | wc -l)
    local non_suivis=$(git status --porcelain | grep "^??" | wc -l)

    echo "üìÑ Fichiers modifi√©s: $modifies"
    echo "‚ûï Fichiers ajout√©s: $ajoutes"
    echo "‚ûñ Fichiers supprim√©s: $supprimes"
    echo "‚ùì Fichiers non suivis: $non_suivis"

    # Derniers commits
    afficher "üìú Derniers commits:" $CYAN
    git log --oneline -5 | while read ligne; do
        echo "   $ligne"
    done
}

git_nettoyage_rapide() {
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        afficher "‚ùå Pas dans un d√©p√¥t Git" $ROUGE
        return 1
    fi

    afficher "üßπ Nettoyage Git..." $JAUNE

    # Nettoyer les branches merg√©es
    local branches_supprimees=0
    git branch --merged | grep -v "\*\|main\|master" | while read branche; do
        git branch -d "$branche" 2>/dev/null && {
            afficher "üóëÔ∏è Branche supprim√©e: $branche" $VERT
            ((branches_supprimees++))
        }
    done

    # Nettoyer les fichiers Git
    git gc --prune=now >/dev/null 2>&1
    afficher "‚úÖ Nettoyage Git termin√©" $VERT
}

git_sauvegarde_rapide() {
    local message="${*:-Sauvegarde rapide}"

    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        afficher "‚ùå Pas dans un d√©p√¥t Git" $ROUGE
        return 1
    fi

    afficher "üíæ Sauvegarde Git rapide..." $CYAN

    git add .
    git commit -m "$message - $(date '+%Y-%m-%d %H:%M')"

    afficher "‚úÖ Sauvegarde effectu√©e: $message" $VERT
}

# ========== SERVEUR DE D√âVELOPPEMENT ==========

serveur_simple() {
    local port="${1:-8000}"
    local dossier="${2:-.}"

    afficher "üåê D√©marrage serveur HTTP simple" $CYAN
    afficher "üìÅ Dossier: $dossier" $CYAN
    afficher "üîó Port: $port" $CYAN
    afficher "üåç URL: http://localhost:$port" $VERT

    # Utiliser Python si disponible
    if command -v python3 >/dev/null; then
        cd "$dossier" && python3 -m http.server "$port"
    elif command -v python >/dev/null; then
        cd "$dossier" && python -m SimpleHTTPServer "$port"
    else
        afficher "‚ùå Python non trouv√© pour serveur HTTP" $ROUGE
        return 1
    fi
}

tester_port() {
    local port="$1"

    if [[ -z "$port" ]]; then
        afficher "‚ùå Usage: tester_port <num√©ro_port>" $ROUGE
        return 1
    fi

    afficher "üîç Test du port $port..." $CYAN

    if netstat -ln 2>/dev/null | grep ":$port " >/dev/null; then
        afficher "üî¥ Port $port occup√©" $ROUGE

        # Trouver le processus
        local processus=$(lsof -i ":$port" 2>/dev/null | tail -1 | awk '{print $2 " " $1}')
        if [[ -n "$processus" ]]; then
            afficher "   Processus: $processus" $JAUNE
        fi
    else
        afficher "‚úÖ Port $port libre" $VERT
    fi
}

# ========== OUTILS DE DOCUMENTATION ==========

generer_readme_simple() {
    local nom_projet="${1:-$(basename "$(pwd)")}"

    afficher "üìù G√©n√©ration README.md pour '$nom_projet'" $CYAN

    cat > README.md << EOF
# $nom_projet

Description courte du projet.

## Installation

\`\`\`bash
# Commandes d'installation
\`\`\`

## Utilisation

\`\`\`bash
# Exemples d'utilisation
\`\`\`

## Fonctionnalit√©s

- [ ] Fonctionnalit√© 1
- [ ] Fonctionnalit√© 2
- [ ] Fonctionnalit√© 3

## D√©veloppement

\`\`\`bash
# Commandes de d√©veloppement
\`\`\`

## Licence

Licence du projet.

---

G√©n√©r√© le $(date '+%Y-%m-%d') avec outils_developpeur.sh
EOF

    afficher "‚úÖ README.md g√©n√©r√©" $VERT
}

generer_gitignore() {
    local type="${1:-general}"

    afficher "üìù G√©n√©ration .gitignore ($type)" $CYAN

    case "$type" in
        "node"|"js")
            cat > .gitignore << 'EOF'
# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.npm
.yarn-integrity

# Environment
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Build
dist/
build/
*.tgz
*.tar.gz

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF
            ;;
        "python"|"py")
            cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/

# Virtual env
venv/
env/
ENV/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF
            ;;
        *)
            cat > .gitignore << 'EOF'
# Fichiers temporaires
*.tmp
*.temp
*~
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Build
build/
dist/
target/

# Environment
.env
.env.local
EOF
            ;;
    esac

    afficher "‚úÖ .gitignore g√©n√©r√© pour $type" $VERT
}

# ========== OUTILS DE TEST ==========

tester_syntaxe() {
    local fichier="$1"

    if [[ -z "$fichier" ]]; then
        afficher "‚ùå Usage: tester_syntaxe <fichier>" $ROUGE
        return 1
    fi

    if [[ ! -f "$fichier" ]]; then
        afficher "‚ùå Fichier '$fichier' introuvable" $ROUGE
        return 1
    fi

    local extension="${fichier##*.}"

    afficher "üîç Test syntaxe: $fichier" $CYAN

    case "$extension" in
        "sh"|"bash")
            if bash -n "$fichier" 2>/dev/null; then
                afficher "‚úÖ Syntaxe Bash OK" $VERT
            else
                afficher "‚ùå Erreur syntaxe Bash" $ROUGE
                bash -n "$fichier"
            fi
            ;;
        "py")
            if command -v python3 >/dev/null; then
                if python3 -m py_compile "$fichier" 2>/dev/null; then
                    afficher "‚úÖ Syntaxe Python OK" $VERT
                else
                    afficher "‚ùå Erreur syntaxe Python" $ROUGE
                fi
            else
                afficher "‚ö†Ô∏è Python3 non disponible" $JAUNE
            fi
            ;;
        "js")
            if command -v node >/dev/null; then
                if node -c "$fichier" 2>/dev/null; then
                    afficher "‚úÖ Syntaxe JavaScript OK" $VERT
                else
                    afficher "‚ùå Erreur syntaxe JavaScript" $ROUGE
                fi
            else
                afficher "‚ö†Ô∏è Node.js non disponible" $JAUNE
            fi
            ;;
        *)
            afficher "‚ö†Ô∏è Type de fichier non support√©: .$extension" $JAUNE
            ;;
    esac
}

# ========== ALIASES ==========

alias analyse='analyser_projet'
alias detect-lang='detecter_langage_projet'
alias gstat='git_statut_propre'
alias gsave='git_sauvegarde_rapide'
alias gclean='git_nettoyage_rapide'
alias serveur='serveur_simple'
alias port='tester_port'
alias readme='generer_readme_simple'
alias gitignore='generer_gitignore'
alias test-syntax='tester_syntaxe'

# ========== AIDE ==========

aide_dev() {
    afficher "üíª OUTILS D√âVELOPPEUR" $BLEU
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo
    afficher "üìä Analyse projet:" $CYAN
    echo "  analyse [dossier]       # Analyser structure projet"
    echo "  detect-lang [dossier]   # D√©tecter langage principal"
    echo
    afficher "üîß Git avanc√©:" $CYAN
    echo "  gstat                   # Statut Git d√©taill√©"
    echo "  gsave [message]         # Sauvegarde rapide"
    echo "  gclean                  # Nettoyage Git"
    echo
    afficher "üåê Serveur dev:" $CYAN
    echo "  serveur [port] [dossier] # Serveur HTTP simple"
    echo "  port <num√©ro>           # Tester si port libre"
    echo
    afficher "üìù Documentation:" $CYAN
    echo "  readme [nom]            # G√©n√©rer README.md"
    echo "  gitignore <type>        # G√©n√©rer .gitignore"
    echo
    afficher "üß™ Tests:" $CYAN
    echo "  test-syntax <fichier>   # Tester syntaxe"
    echo
    afficher "üí° Exemples:" $JAUNE
    echo "  analyse .               # Analyser projet actuel"
    echo "  serveur 3000            # Serveur sur port 3000"
    echo "  gitignore node          # .gitignore pour Node.js"
}

alias aide-dev='aide_dev'

afficher "‚úÖ Outils d√©veloppeur charg√©s" $VERT
afficher "üí° Tapez 'aide-dev' pour voir toutes les commandes" $CYAN